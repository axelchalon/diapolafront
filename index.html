<!doctype html>
<html>

<head>
    <meta charset="utf-8">
    <script src="https://unpkg.com/vue"></script>
    <script src="js/prefixfree.min.js"></script>
    <link href="https://fonts.googleapis.com/css?family=Montserrat:300,300i,400,400i,500,500i" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
</head>

<body>
    
    
    <div class="gridtest grid">
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
        <div class="gridtest a"></div>
    </div>
    
    <div id="app">
        
        <div class="signUp" v-if="signUpShown">
            <div class="signUp_modal">
                <h3>S'inscrire</h3>
                
                <form>
                    
                    <div class="signUp_modal_left">
                        <label for="signUp_lastname">Nom</label><br>
                        <input type="email" id="signUp_lastname"><br>
                    </div>
                    <div class="signUp_modal_right">
                        <label for="signUp_firstname">Prénom</label><br>
                        <input type="email" id="signUp_firstname"><br>
                    </div>
                    <div style="clear:both;"></div>
                    
                    <label for="signUp_email">Adresse mail</label><br>
                    <input type="email" id="signUp_email"><br>
                    
                    <div class="signUp_modal_left">
                        <label for="signUp_password">Mot de passe</label><br>
                        <input type="password" id="signUp_password"><br>
                    </div>
                    <div class="signUp_modal_right">
                        <label for="signUp_password_confirm">Mot de passe</label><br>
                        <input type="password" id="signUp_password_confirm"><br>
                    </div>
                    <div style="clear:both;"></div>
                    
                    
                    <button type="submit" @click.prevent="signUp($event.target.parentNode.querySelector('#signUp_lastname').value, $event.target.parentNode.querySelector('#signUp_firstname').value, $event.target.parentNode.querySelector('#signUp_email').value, $event.target.parentNode.querySelector('#signUp_password').value, $event.target.parentNode.querySelector('#signUp_password_confirm').value)">Créer mon compte</button>
                    
                    <small>Déjà un compte ? <a href="#" @click.prevent="signUpShown = false">Se connecter</a></small>
                </form>
            </div>
        </div>
        
        <div class="login" v-if="!account.loggedIn && !signUpShown">
            <div class="login_modal">
                <h3>S'identifier</h3>
                
                <form>
                    <label for="login_email">Adresse mail</label><br>
                    <input type="email" id="login_email"><br>
                    
                    
                    <label for="login_password">Mot de passe</label><br>
                    <input type="password" id="login_password"><br>
                    
                    
                    <button type="submit" @click.prevent="logIn($event.target.parentNode.querySelector('#login_email').value, $event.target.parentNode.querySelector('#login_password').value)">Se connecter</button>
                    
                    <small>Pas encore de compte ? <a href="#" @click.prevent="signUpShown = true">S'inscrire</a></small>
                </form>
            </div>
        </div>
        
        <div class="app" v-if="account.loggedIn">
            <div class="topBar">
                <h1 class="logo"></h1>

                <div class="search">
                    <input type="search" placeholder="Rechercher dans vos présentations" @keyup.enter="search($event.target.value); $event.target.value=''; ">
                </div>
                    
                <div class="iconsOnTheRight">
                    <a href="#" class="showManageCollaborators" @click.prevent="manageCollaboratorsShown = true; manageCollaboratorsToastMessage = '';"></a>
                    
                    <div class="myProfile">
                        <a href="#" :style='{"background-image": "url(" + account.avatarPreviewUrl + ")"}' onclick="this.parentNode.querySelector('.component_burger_toggle').click()"></a>
                        <burger align="right" :items="[{text: 'Mon compte'}, {text: 'Déconnexion', callback: logOut}]"></burger>
                    </div>
                </div>

                <div style="clear: both;"></div>
                <!-- ---- -->
                <div class="topBar_innerSeparator"></div>

                <button class="importPresentation" href="#">Importer une présentation</button>

                <div class="breadcrumbs" v-if="page == 'presentation'">
                    <a class="breadcrumbs_breadcrumb breadcrumbs_breadcrumb-active" href="#" >{{ presentationTitle }}</a>
                    <burger align="left" :items="[{text: 'Mots-clés', callback: presentationShowKeywords}, {text: 'Renommer', callback: presentationRename}, {text: 'Supprimer', callback: presentationShowConfirmDelete}]"></burger>
                </div>
            </div>

            <div class="page">

                <div class="page_left">
                    <ul>
                        <li v-for="presentation in presentations"><a href="#" @click.prevent="goToPresentation(presentation.id)">{{presentation.title}}</a></li>
                    </ul>
                </div>

                <div class="page_right">
                    <div class="page_right_topBar page_right_topBar-presentation" v-if="page == 'presentation'">
                        <button class="downloadPresentation">Télécharger la présentation</button>
                        <!--<button class="downloadSelectedSlides downloadSelectedSlides-disabled">Télécharger la sélection</button>-->

                        <div class="presentationComment">
                            <h3>Commentaire</h3> <a href="#" class="presentationComment-edit">Modifier</a><br>
                            <p>{{presentationComment}}</p>
                        </div>
                    </div>

                    <div v-if="page == 'search'" class="page_right_topBar page_right_topBar-search">
                        <h2>{{searchResults.length}} résultats trouvés pour &ldquo;{{searchQuery}}&rdquo;</h2>

                        <ul>
                            <li :class="{active: searchTab == 'all'}"><a href="#" @click.prevent="searchTab = 'all'">Tout ({{searchResults.length}})</a></li>
                            <li :class="{active: searchTab == 'slides'}"><a href="#" @click.prevent="searchTab = 'slides'">Slides ({{searchResultsSlides.length}})</a></li>
                            <li :class="{active: searchTab == 'presentations'}" @click.prevent="searchTab = 'presentations'"><a href="#">Présentations ({{searchResultsPresentations.length}})</a></li>
                        </ul>
                    </div>

                    <div v-if="page == 'search'" class="page_right_page">
                        <a v-for="searchResult in (searchTab == 'all' ? searchResults : searchTab == 'slides' ? searchResultsSlides : searchResultsPresentations)"  :style='{"background-image": "url(" + searchResult.previewUrl + ")"}' href="#" @click.prevent="searchResult.type == 'slide' ? launchDiaporamaOnSlide(searchResult.id) : goToPresentationForSlide(searchResult)"
                            :class="{page_right_page_slide: searchResult.type == 'slide', page_right_page_presentation: searchResult.type == 'presentation', }"
                           >

                            <p 
                               :class="{page_right_page_slide_presentationTitle: searchResult.type == 'slide', page_right_page_presentation_presentationTitle: searchResult.type == 'presentation'}">{{searchResult.presentationTitle || searchResult.title}}</p>
                        </a>
                    </div>

                    <div v-if="page == 'presentation'" class="page_right_page">
                        <a v-for="presentationSlide in presentationSlides" class="page_right_page_slide" href="#" 
                           :style='{"background-image": "url(" + presentationSlide.previewUrl + ")"}' @click.prevent="launchDiaporamaOnSlide(presentationSlide.id)">
                        </a>
                    </div>


                </div>
            </div>

            <div class="bottomBar" :class='{"bottomBar-active": bottomBarActive}'>
                <a class="bottomBar_toggler" href="#" @click.prevent="bottomBarActive = !bottomBarActive"></a>
                
                <div class="bottomBar_top">
                    <button class="downloadGeneratedPresentation" href="#">Télécharger</button>
                    <button class="saveGeneratedPresentation" href="#">Sauvegarder</button>
                    <a class="clearGeneratedPresentation" href="#" @click.prevent="generatedPresentationSlides = []"><span class="clearGeneratedPresentation_icon"></span>Tout effacer</a>
                </div>
                
                <div style="clear:both;"></div>

                <div class="bottomBar_delineator"></div>

                <ul class="bottomBar_listOfSlides">
                    <li v-for="(generatedPresentationSlide, index) in generatedPresentationSlides" class="bottomBar_listOfSlides_slide">
                        <div class="bottomBar_listOfSlides_slide_image" :style='{"background-image": "url(" + generatedPresentationSlide.previewUrl + ")"}'></div>
                        <p class="bottomBar_listOfSlides_slide_title">{{generatedPresentationSlide.title}}</p>
                        <a class="bottomBar_listOfSlides_slide_remove" href="#" v-on:click.prevent="removeGeneratedPresentationSlide(index)">
                            &times;
                        </a>
                    </li>

                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                    <li class="bottomBar_listOfSlides_placeholder"></li>
                </ul>
            </div>
            
            <div v-show="manageCollaboratorsShown" class="manageCollaborators">
                <div class="manageCollaborators_modal">
                    <a href="#" class="manageCollaborators_modal_close" @click.prevent="manageCollaboratorsShown = false">&times;</a>
                    <h3>Ajouter un nouveau collaborateur</h3>
                    
                    {{manageCollaboratorsToastMessage}}
                    
                    <div class="manageCollaborators_addCollaborator">
                        <input placeholder="adresse@mail.fr">
                        <button @click.prevent="addCollaborator($event.target.parentNode.querySelector('input').value); $event.target.parentNode.querySelector('input').value='';">+</button>
                    </div>
                    
                </div>
            </div>

            <div v-show="presentationKeywordsShown" class="presentationKeywords">
                <div class="presentationKeywords_modal">
                    <a href="#" class="presentationKeywords_modal_close" @click.prevent="presentationKeywordsShown = false">&times;</a>
                    <h3>Mots-clés de la présentation</h3>
                    <tags :tags="presentationTags" :on-tag-add="addTagToPresentation" :second="-1" :on-tag-remove="removeTagFromPresentation"></tags>
                </div>
            </div>

            <div v-show="presentationConfirmDeleteShown" class="presentationShowConfirmDelete">
                <div class="presentationShowConfirmDelete_modal">
                    <a href="#" class="presentationShowConfirmDelete_modal_close" @click.prevent="presentationConfirmDeleteShown = false">&times;</a>
                    <h3>Êtes-vous sûr de vouloir supprimer la présentation ?</h3>
                    <button class="presentationShowConfirmDelete_modal_yes" @click.href="deletePresentation">Oui</button>
                    <button class="presentationShowConfirmDelete_modal_no" @click.href="presentationConfirmDeleteShown = false">Non</button>
                </div>
            </div>

            <div v-if="diaporamaMode" class="diaporama">

                <a href="#" @click.prevent="diaporamaMode = false" class="diaporama_exit">&times;</a>

                <div class="diaporama_previousSlide" v-if="diaporamaCurrentSlideIndex > 0" :style='{"background-image": "url(" + diaporamaSlides[diaporamaCurrentSlideIndex-1].viewUrl + ")"}' @click.prevent="diaporamaCurrentSlideIndex--"></div>
                <div class="diaporama_nextSlide" v-if="diaporamaCurrentSlideIndex < diaporamaSlides.length-1" :style='{"background-image": "url(" + diaporamaSlides[diaporamaCurrentSlideIndex+1].viewUrl + ")"}' @click.prevent="diaporamaCurrentSlideIndex++"></div>

                <div class="diaporama_currentSlide" :style='{"background-image": "url(" + diaporamaSlides[diaporamaCurrentSlideIndex].viewUrl + ")"}'></div>
                <div class="diaporama_currentSlideInformation">
                    <div class="diaporama_currentSlideInformation_tags">
                        <h3>Mots-clés</h3>
                        <tags :tags="diaporamaSlides[diaporamaCurrentSlideIndex].tags" :on-tag-add="addTagToSlide" :second="diaporamaSlides[diaporamaCurrentSlideIndex].id" :on-tag-remove="removeTagFromSlide"></tags>
                    </div>
                    <div class="diaporama_currentSlideInformation_comment">
                        <h3>Commentaire de diapositive</h3>
                        <p>{{diaporamaSlides[diaporamaCurrentSlideIndex].comment}}</p>
                    </div>
                </div>

                <div class="diaporama_banner">
                    <div class="diaporama_banner_text">
                        <h3>{{diaporamaPresentationTitle}}</h3>
                        <small>{{diaporamaCurrentSlideIndex+1}}/{{diaporamaSlides.length}}</small>
                    </div>

                    <a class="diaporama_gotoPreviousSlide" href="#" v-if="diaporamaCurrentSlideIndex > 0" @click.prevent="diaporamaCurrentSlideIndex--"></a>
                    <a class="diaporama_gotoNextSlide" href="#" v-if="diaporamaCurrentSlideIndex < diaporamaSlides.length-1" @click.prevent="diaporamaCurrentSlideIndex++"></a>
                </div>
                
                <a href="#" class="diaporama_addToGeneratedPresentation">Ajouter à la collection</a>

            </div>
        </div>
    </div>

    
    <script src="js/api.js"></script>
    <script>
        
        // register
        Vue.component('burger', {
          props: {
              items: Array,
              align: String
          },
          data: function() {
              return {active: false};
          },
          template: `
                <div class="component_burger" v-bind:class='{"component_burger-active": active, "component_burger-alignLeft": align == "left", "component_burger-alignRight": align == "right" }'>
                    <a href="#" v-on:click.prevent="active = !active" class="component_burger_toggle">&#8226;&#8226;&#8226;</a>
                    <ul>
                        <li v-for="item in items"><a href="#" @click.prevent="item.callback(); active = false;">{{item.text}}</a></li>
                    </ul>
                </div>`
        })
        
        Vue.component('tags', {
          props: {
              tags: Array,
              onTagAdd: Function,
              second: Number,
              onTagRemove: Function,
          },
          methods: {
            onTagAddLol: function(wooby,wb) {
                this.onTagAdd(wooby,this.second)
            },
            onTagRemoveLol: function(wooby,wb) {
                this.onTagRemove(wooby,this.second)
            }
          },
          template:
            `<div class="component_tags">
                <ul>
                    <li class="component_tags_tag" v-for="tag in tags">
                        <a class="component_tags_tag_close" href="#" @click.prevent="onTagRemoveLol(tag)">
                            &times;
                        </a>
                        {{tag}}
                    </li>
                </ul>

                <div class="component_tags_addTag">
                    <input placeholder="Ajouter un tag">
                    <button @click.prevent="onTagAddLol($event.target.parentNode.querySelector('input').value); $event.target.parentNode.querySelector('input').value='';">+</button>
                </div>
            </div>`
        })
        
        var app = new Vue({
            el: '#app',
            data: {
                account: {
                  loggedIn: true,
                  avatarPreviewUrl: "https://placecage.com/50/50"
                },
                signUpShown: false,
                bottomBarActive: true,
                page: "",
                presentations: [],
                manageCollaboratorsShown: false,
                manageCollaboratorsToastMessage: '',
                diaporamaMode: true,
                diaporamaPresentationTitle: "Nom de la préz!",
                diaporamaCurrentSlideIndex: 0,
                diaporamaSlides: [{viewUrl: "https://www.placecage.com/1200/900", tags: ["onea","oneb","onec"], comment: "Lorem ipsum..."}, {viewUrl: "https://www.placecage.com/1200/900", tags: ["twox","twoc","twod"], comment: "Lorem ipsum 2..."}, {viewUrl: "https://www.placecage.com/1200/900", tags: ["threea","threeb","threec"], comment: "Lorem ipsum 3..."} ],
                presentationId: -1,
                presentationTitle: "",
                presentationTags: ["", ""],
                presentationSlides: [{},{},{},{},{},{},{}],
                presentationComment: "Duis ultrices vestibulum lacus non luctus. Praesent aliquet, justo ut accumsan bibendum, sem erat sagittis nunc, a vulputate diam ulla nisi.",
                presentationKeywordsShown: false,
                presentationConfirmDeleteShown: false,
                generatedPresentationSlides: [{title: "Nom de la présentation",previewUrl: "https://www.placecage.com/200/130"}],
                searchTab: "all",
                searchQuery: "",
                searchResults: []
            },
            computed: {
                searchResultsSlides: function() {
                    return this.searchResults.filter(x => x.type == "slide");
                },
                searchResultsPresentations: function() {
                    return this.searchResults.filter(x => x.type == "presentation");
                }  
            },
            methods: {
                _catchFn: function(err) {        console.error('ERR',err); // this.logOut();
                },
                addCollaborator: function(email) {
                    if (email.trim() == '') return;
                    
                    API.addCollaborator(email).then(() => {
                        this.manageCollaboratorsToastMessage = email + ' a bien été invité !';
                    }).catch(this._catchFn);
                },
                removeGeneratedPresentationSlide: function(index) {
                    this.$delete(this.generatedPresentationSlides, index);
                },
                launchDiaporamaOnSlide: function(slideId) {
                    for (var i = 0; i < this.diaporamaSlides.length; i++) {
                        console.log('launchdiaporma o',slideId,'&this id',this.diaporamaSlides[i].id)
                        if (slideId == this.diaporamaSlides[i].id) {
                            this.diaporamaCurrentSlideIndex = i;
                                break;
                        }
                    }
                    this.diaporamaMode = true;
                    // hydrate diaporamaPresentationTitle
                    // hydrate diaporamaCurrentSlideIndex
                    // diaporamaSlides
                },
                addTagToPresentation: function(tag) { API.addTagToPresentation(tag,this.presentationId).then((res) => {
                        console.log('add ok',res)
                        this.presentationTags.push(tag);
                    })
                },
                removeTagFromPresentation: function (tag) {
                 API.removeTagFromPresentation(tag,this.presentationId).then((res) => {
                        
                       console.log('wubba dubba dub dub',res) ;

                        this.presentationTags = this.presentationTags.filter(x => x != tag);
                  });
                },
                addTagToSlide: function(tag,slideId) {
                    console.log('addtagtoslide',tag,slideId)
                  // faire requête serveur pour update tags
                    API.addTagToSlide(tag,slideId).then((res) => {
                        
                       console.log('res !!',res) ;
                        
                        this.diaporamaSlides[0].tags.push(tag);
                    }).catch(this._catchFn)
                },
                removeTagFromSlide: function (tag,slideId) {
                 console.log('removetagfromslide',tag,slideId) ;
                    API.removeTagFromSlide(tag,slideId).then((res) => {
                        
                       console.log('res rem tag slide !!',res) ;

                        this.diaporamaSlides[0].tags = this.diaporamaSlides[0].tags.filter(x => x != tag);
                  });
                },
                goToPresentation: function(id) {
                    API.getPresentationInfo(id).then((res) => {
                        console.log('woupi', res)
                        console.log(res);
                        var slidz = res.slides.map((t) => {
                            t.previewUrl = HOST + t.thumbnail_url;
                            t.viewUrl = HOST + t.picture_url;
                            t.comment = t.description;
                            t.tags = t.tags.map((x) => x.value);
                            return t;
                        });
                        this.presentationSlides = slidz;
                        
                        this.presentationId = id;
                        this.presentationTags = res.tags.map((x) => x.value);
                        this.presentationComment = res.description;
                        this.presentationTitle = res.title;
                        this.diaporamaSlides = slidz;
                          
                        
                        this.page="presentation";
                    });
                },
                goToPresentationForSlide: function(slide) {
                    // faire requête serveur pour récup liste des slides de la présentation et infos présentation
                    this.page = 'presentation';  
                    // presentationTags...
                },
                presentationShowKeywords: function() {
                  this.presentationKeywordsShown = true;
                },
                presentationRename: function() {
                    var newname = prompt(':hap:') ;
                    API.renamePresentation(newname,this.presentationId).then(res => {
                        console.log('renamed',res);
                        var oldname = this.presentationTitle;
                        this.presentationTitle = newname;
                        this.presentations = this.presentations.map(prez => {
                            prez.title = prez.title == oldname ? newname : prez.title;
                            return prez;
                        }
                        )
                    })
                },
                presentationShowConfirmDelete: function() {
                  this.presentationConfirmDeleteShown = true;
                },
                deletePresentation: function() {
                    var id = this.presentationId;
                    console.log('DEL');
                    this.presentationConfirmDeleteShown = false;
                    API.deletePresentation(id).then((res) => {
                        // @todo redirect home
                        console.log('del res',res)    
                    }).catch(this._catchFn);
                    
                },
                logIn: function(email,password) {
                    console.log(email,password)
                    API.logIn(email,password).then((res) => {
                        console.log('(VUE) API RESPONSE :',res)
                        this.account.loggedIn = true;
                        
                        this.getPresentations();
                        
                    }).catch(this._catchFn)
                },
                signUp: function(lastname,firstname,email,password,password_confirm) {
                    console.log(lastname,firstname,email,password,password_confirm)
                    
                    API.signUp(lastname,firstname,email,password,password_confirm).then((res) => {
                        console.log('(VUE) API RESPONSE :',res)
                        this.account.loggedIn = true;
                        this.signUpShown = false;
                    }).catch(this.logOut)
                },
                logOut: function () {
                    
                  API.logOut().then((res) => {
                    console.log('log out');
                    this.account.loggedIn = false;
                  });
                },
                getPresentations: function() {
                  API.getPresentations().then((res) => {
                        console.log('(VUE) GET PRESENTATIONS',res)
                        this.presentations = res.sort();
                    })
                },
                search: function (q) {
                    this.page = "search";
                    this.searchTab = "all";
                    this.searchQuery = q;
                    this.searchResults = [
                        {
                            presentationTitle: "Slide prez",
                            type: "slide",
                            previewUrl: "https://www.placecage.com/200/130"
                        },
                        {
                            presentationTitle: "Slide prez",
                            type: "slide",
                            previewUrl: "https://www.placecage.com/200/130"
                        },
                        {
                            presentationTitle: "Slide prez",
                            type: "slide",
                            previewUrl: "https://www.placecage.com/200/130"
                        },
                        {
                            title: "Presentation",
                            type: "presentation",
                            previewUrl: "https://www.placecage.com/200/130"
                        }
                    ];
                }
            }
        })
        
        app.getPresentations();
        
        var skip = false;
        function hashChanged() {
            if (skip) {
                console.log('skip');
                setTimeout(() => {
                    skip = false
                }, 200);
                return;
            }
            console.log('hash upd');
            var hash = window.location.hash.substr(1);
            if (hash == 'hello')
                {
                    console.log('HELLO')
                    skip = true;
                    window.location.hash='';
                }
        }

        window.onhashchange = hashChanged;
        hashChanged();

    </script>
            

</body>

</html>